Je veux ajouter un systÃ¨me complet de messagerie en temps rÃ©el dans mon application. Merci de lire tout le projet et dâ€™implÃ©menter proprement la fonctionnalitÃ©. Voici les exigences exactes, incluant toutes les rÃ¨gles de permission.

ğŸ”’ 1. RÃ´les & rÃ¨gles de permission
RÃ´les disponibles

student

teacher

admin

Qui peut lancer une conversation avec qui

student â†’ teacher : OUI

student â†’ admin : OUI

teacher â†’ student : NON

teacher â†’ admin : OUI

admin â†’ teacher : OUI

admin â†’ student : OUI

Qui voit quels contacts

student : voit tous les teachers et tous les admins

teacher : voit uniquement les admins

admin : voit les students ET les teachers

RÃ¨gle importante

Les permissions ci-dessus doivent Ãªtre appliquÃ©es :

pour afficher la liste des contacts

pour autoriser lâ€™ouverture dâ€™une conversation

pour autoriser lâ€™envoi dâ€™un message

ğŸ—ƒï¸ 2. Structure de donnÃ©es (Drizzle ORM)

CrÃ©er une table conversations :

id (PK)

participantA (FK user)

participantB (FK user)

createdAt

CrÃ©er une table messages :

id (PK)

conversationId (FK)

senderId (FK user)

content

createdAt

Une conversation doit Ãªtre unique pour un pair (A,B).
Si une conversation nâ€™existe pas, la crÃ©er automatiquement seulement si la permission existe.

ğŸ§  3. Endpoints API
POST /conversations/start

Body : { targetUserId }

VÃ©rifier si lâ€™utilisateur a le droit de lancer une conversation

CrÃ©er la conversation si elle nâ€™existe pas

Retourner la conversation

GET /conversations/list

Retourner toutes les conversations de lâ€™utilisateur connectÃ©

GET /conversations/:id/messages

Retourner les messages dâ€™une conversation

POST /messages/send

Body : { conversationId, content }

VÃ©rifier que lâ€™utilisateur fait partie de la conversation

VÃ©rifier que lâ€™envoi est autorisÃ© selon les permissions

Sauvegarder le message

Ã‰mettre un Ã©vÃ©nement temps rÃ©el

âš¡ 4. Temps rÃ©el (Socket.IO obligatoire)

Une connexion socket doit Ãªtre authentifiÃ©e via le JWT dÃ©jÃ  utilisÃ© dans le projet

Lors de lâ€™envoi dâ€™un message :

lâ€™expÃ©diteur reÃ§oit le message immÃ©diatement

le destinataire reÃ§oit lâ€™Ã©vÃ©nement instantanÃ©ment

Mettre Ã  jour automatiquement lâ€™UI sans rechargement

ğŸ¨ 5. Interface front-end

CrÃ©er une interface moderne simple :

Liste des contacts autorisÃ©s (selon les rÃ¨gles)

Liste des conversations existantes

FenÃªtre de chat

Messages alignÃ©s Ã  droite pour lâ€™expÃ©diteur, gauche pour le destinataire

Actualisation instantanÃ©e via WebSockets

ğŸ” 6. SÃ©curitÃ© et validation

Tous les contrÃ´les de permission doivent Ãªtre centralisÃ©s dans une fonction canUserStartConversation(user, targetUser)

VÃ©rifier Ã©galement lors de lâ€™envoi de message quâ€™il nâ€™y a pas de contournement (ex : teacher â†’ student).

VÃ©rifier que la conversation appartient bien aux deux participants.

ğŸ§© 7. Ce que jâ€™attends de Replit AI

Lire totalement le projet

CrÃ©er toutes les tables Drizzle

Mettre Ã  jour le backend (routes + sockets)

Mettre Ã  jour le frontend (UI + sockets)

Faire le code complet, propre et testÃ©

Ne rien casser dans les autres fonctionnalitÃ©s

Montrer les diffs, puis insÃ©rer directement dans les fichiers

Merci de procÃ©der proprement, Ã©tape par Ã©tape.